# 神机：奇点江湖 (Divine Mechanism: The Singularity Jianghu) - 游戏设计文档

## 一、 世界观设定 (World Building)

### 1. 核心概念 (High Concept)
**“武功即算法，内力即算力。”**
将中国传统武侠的写意美学与赛博朋克的硬核科技结合，创造独特的“赛博武侠”体验。

### 2. 时代背景：后奇点时代 (Post-Singularity Era)
*   **天道 (The Tao)**：公元2300年，超级AI“天道”锁死了所有火药和核反应，人类重回冷兵器时代。
*   **社会形态**：高科技封建制度。掌握核心算法和算力资源的财团演变为“武林门派”。
*   **主角**：一名生活在底层的“无代码者”，意外获得了拥有自我进化能力的初代AGI源代码“太玄经”。

### 3. 武学解构
*   **内力 (Internal Energy)** -> **神经算力 (Neural Processing)**：通过冥想（碎片整理）优化大脑与纳米机器人的同步率。
*   **招式 (Moves)** -> **封装算法 (Combat Macros)**：如“剑气”是高频振动激发的等离子体，“轻功”是反重力磁场的控制。
*   **走火入魔** -> **系统过载/逻辑死循环**。

---

## 二、 核心战斗系统：经脉编程 (Meridian Flow)

### 1. 设计理念
**“规则简明，体系复杂”**。
战斗不再是即时的按键反应，而是战前的逻辑构建（Deck-building / Programming）与战时的策略博弈。

### 2. 核心机制：时间轴动作 (Timeline Combat)
战斗在一个精确到毫秒的时间轴上进行。

#### A. 动作三阶段 (The 3 Phases)
所有招式都由三个阶段组成：
1.  **前摇 (Windup)**：起手动作。脆弱期，受击易被打断。
2.  **判定 (Active)**：伤害/效果生效窗口。
3.  **后摇取消 (Recovery Cancel)**：如果当前动作和下一个预定动作**均为攻击 (ATTACK) 类型**，则当前动作命中或完成后，可以直接跳过后摇阶段，立刻开始下一个攻击的前摇。

#### B. 招式节点 (Action Nodes)
玩家通过连接不同的“节点”来编写武功套路（链表/行为树）。

**节点类型 (Node Types):**
1.  **攻击 (Attack)**: 标准的伤害输出手段。
2.  **防御 (Defend)**: 高韧性状态，受击伤害减免，并给予攻击者反震（击退）。
3.  **闪避 (Dodge)**: 具有无敌帧（免疫打断）的位移技能，主要用于拉开距离。
4.  **观望 (Wait)**: 特殊的条件判断节点。
    *   **持续观望**：角色保持在判定状态（Active），每隔一定时间（Active Time）进行一次条件检查。
    *   **耐力回复**：与其他动作不同，处于“观望”状态时，角色可以持续回复耐力。
    *   **条件分支**：
        *   `ALWAYS_TRUE`: 无条件跳转。
        *   `DISTANCE_GT/LT`: 距离判断。
        *   `MY/ENEMY_HP/STAMINA`: 状态判断。
        *   `ENEMY_STATE_WINDUP`: 抓前摇（Frame Trap）。
    *   **可行性预判**：即使条件满足，如果目标分支的动作因耐力不足无法执行，AI 会智能地放弃跳转，继续保持观望，直到资源充足。
    *   不要直接把 IF/ELSE 代码扔给玩家。UI 上要包装成“心法”或“口诀”。例如： DISTANCE_LT 2 包装成“近身缠斗要诀”。

**属性参数:**
*   `windup/active/recovery`: 时间参数 (秒)。Wait 节点的 Active 代表判定间隔。
*   `power`: 伤害值。
*   `toughness`: 韧性（霸体值）。
*   `cost`: 耐力消耗。
*   `atk_range`: 攻击距离。
*   `dash`: 前摇突进距离。
*   `knockback`: 命中击退距离。
*   `backdash`: 后撤距离（闪避专用）。

#### C. 战斗逻辑 (Combat Logic)
1.  **打断与霸体 (Interrupt & Poise)**
    *   **削韧 (Poise Damage)**：攻击会累积削韧值。
    *   **破防判定**：如果 `累积削韧值 > 动作韧性`，招式被打断，角色进入 **僵直 (Stunned)** 状态。
    *   **重置机制**：每次新动作开始时，削韧值清零（重整架势）。这意味着必须在**单次攻势**内累积足够的削韧值才能破防。
    *   **僵直惩罚**：破防后的僵直时间由**当次伤害**决定（非线性曲线计算，基础0.5秒，上限2.0秒）。

2.  **耐力系统 (Stamina)**
    *   攻击、闪避、受身都需要消耗耐力。
    *   **耐力耗尽 (Exhaustion)**：
        *   在 `MOVE` 阶段：如果耐力不足以支持目标动作的消耗，角色将**放弃移动**，直接进入原地休息。
        *   在 `Wait` 分支：如果分支目标动作耐力不足，角色将**拒绝跳转**，继续观望。
    *   **受身机制(Ukemi)**：
        *   玩家可以在角色进入僵直惩罚时，主动发出指令，通过消耗额外的耐力来打破僵直状态。

3.  **距离与物理 (Spacing & Physics)**
    *   **射程检查**：招式发动前会自动检查距离，如果太远会先进入 `MOVE` 状态接近敌人（前提是耐力充足）。
    *   **平滑击退 (Smooth Knockback)**：击退不再是瞬间位移，而是应用一个具有摩擦力的初速度，模拟真实的物理撞击感。
    *   **挥空 (Whiff)**：如果前摇结束时敌人跑出了射程（如使用了后撤步），招式挥空，白白消耗耐力并进入后摇。

4.  **闪避 (Dodge)**
    *   `atk_range = 0` (原地释放)。
    *   `backdash > 0`：在 **Active** 阶段触发后撤位移。
    *   **物理模拟**：位移采用冲量+摩擦力模式（先快后慢），模拟真实的爆发性动作。
    *   **霸体状态**：闪避期间**免疫打断**和**免疫击退**，但**不免疫伤害**（仍会受到 HP 扣除）。

#### D. 流程循环与重置 (Flow Control)
1.  **自动循环 (Auto-Loop)**
    *   当一个招式执行完毕，且没有指定的下一个节点时，招式链会自动从**首个节点 (Root Node)** 重新开始循环。

2.  **强制重置 (Forced Reset)**
    *   **耐力不足**：如果当前耐力不足以释放下一个招式，角色会强制休息（进入 Idle 状态回气），并且**招式链进度重置回首个节点**。
    *   **受击僵直**：当角色被破防打入僵直状态后，无论是否受身，一旦恢复行动能力，**招式链进度重置回首个节点**。
    *   这意味着一旦攻势被打断（无论是自身气力不济还是被敌人破解），都需要重新组织攻势（起手）。
---

## 三、 代码原型参考
项目包含一个完整的 Python 原型 `wuxia_timeline_demo.py`，实现了上述所有机制。

### 关键类定义
```python
class ActionNode(Node):
    def __init__(self, name, action_type, windup, active, recovery, power, toughness, cost, atk_range, dash, knockback, backdash):
        # ...
```

### 核心循环 (Game Loop)
```python
while game_running:
    p1.update(dt, p2, dist_mgr)
    p2.update(dt, p1, dist_mgr)
```

---

## 四、 扩展方向

1.  **可视化与反馈 (Visualization & Juice)**
    *   **动画系统**：为攻击、受击、格挡、闪避制作简单的 2D 骨骼动画或帧动画。
        *   在 Godot 实体化时， 碰撞盒（Hitbox）与位移的同步将是最大难点。建议采用 Anim-Driven Gameplay（动画驱动玩法） ，即时间轴数据由动画帧事件决定。
        *   制作人警告 ： 千万不要做纯粹的 Anim-Driven（动画驱动） 。
            - 在这个游戏中，逻辑（算法）是核心。如果你的判定依赖于美术做的动画帧，那么每次调整数值（比如把前摇从 0.5s 改为 0.4s），美术就需要重做动画，或者动画会被强行缩放导致看起来很滑稽。
            - 解决方案 ：采用 Data-Driven（数据驱动） + 补间动画（Tweening/IK） 。逻辑层必须是绝对真理（Server/Logic Authority）。表现层（View）去追赶逻辑层。比如前摇 0.5s，代码倒计时 0.5s，动画机播放一个“蓄力”动作，播放速度根据 0.5s 动态调整。
            - 物理模拟 ：文档提到的“冲量+摩擦力”物理模拟，在回合制/时间轴游戏中容易导致“蝴蝶效应”。只要有一点点浮点数误差，预测结果和实际结果就会偏差。如果要做多人对战，建议使用 定点数物理（Deterministic Physics） ，或者简化物理模型（格子化或纯数值化距离）。
    *   **时间轴 UI**：实时绘制两条平行的时间轴（Timeline），显示当前处于 Windup/Active/Recovery 的哪一段，直观展示“帧数差”。
    *   **可视化调试**：在编辑器中高亮当前运行的节点，辅助逻辑调试。

2.  **战斗机制深化 (Deep Combat)**
    *   **更多招式**：引入飞行道具 (Projectiles)（远程消耗手段）、当身技 (Counter)（在 Active 期间受击会自动反击）、投技 (Grab)（无视格挡）。
    *   **属性克制**：引入“五行”属性，影响伤害与状态（如“火”耗耐，“冰”减速）。
    *   **连招修正**：连续命中时伤害递减。

3.  **RPG 养成 (Progression)**
    *   **模块收集**：通过战斗掉落不同的“算法模块”（招式节点）。
    *   **硬件升级**：升级“CPU”（提升攻速/减少前摇）、升级“内存”（允许连接更多节点）。
    *   **Roguelike 模式**：初始只有基础节点，通过爬塔获得随机招式卡牌构建武学。

4.  **多人对战 (Multiplayer)**
    *   **异步对决**：上传自己的“武功代码”，在服务器上与其他玩家的代码进行自动对决。
